
<!-- 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 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Time Slots</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
        }
        input, select {
            padding: 8px;
            width: 200px;
            margin-right: 10px;
        }
        button {
            padding: 10px 20px;
        }
        #confirmationMessage {
            display: none;
            padding: 10px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Manage Time Slots</h1>

    <!-- Form for Blocking Time Slots -->
    <h2>Block Time Slot</h2>
    <form id="blockForm">
        <label for="blockDate">Select Date:</label>
        <input type="date" id="blockDate" name="blockDate" required>
        
        <label for="blockTime">Select Time:</label>
        <select id="blockTime" name="blockTime" required>
            <option value="">Select a time</option>
        </select>

        <button type="submit">Block Time Slot</button>
    </form>

    <!-- Form for Unblocking Time Slots -->
    <h2>Unblock Time Slot</h2>
    <form id="unblockForm">
        <label for="unblockDate">Select Date:</label>
        <input type="date" id="unblockDate" name="unblockDate" required>
        
        <label for="unblockTime">Select Time:</label>
        <select id="unblockTime" name="unblockTime" required>
            <option value="">Select a time</option>
        </select>

        <button type="submit">Unblock Time Slot</button>
    </form>

    <!-- Form for Adding New Time Slots -->
    <h2>Add New Time Slots</h2>
    <form id="addForm">
        <label for="newDate">Select Date:</label>
        <input type="date" id="newDate" name="newDate" required>

        <button type="submit">Add Time Slots</button>
    </form>

    <!-- Display confirmation message -->
    <div id="confirmationMessage"></div>

    <!-- Display blocked time slots -->
    <h2>Blocked Time Slots</h2>
    <ul id="blockedItems"></ul>
    <script>
    // GitHub configuration
    const token = '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'; // Replace with your GitHub PAT
    const repoOwner = 'Varmaclinic'; // Replace with your GitHub username
    const repoName = 'blocked-dates'; // Replace with your repository name
    const filePath = 'blocked-dates.json'; // Path to your JSON file in the repo
    
    // Time slot intervals
    const morningSlots = [
        "09:00", "09:15", "09:30", "09:45", 
        "10:00", "10:15", "10:30", "10:45", 
        "11:00", "11:15", "11:30", "11:45"
    ];
    const eveningSlots = [
        "18:30", "18:45", "19:00", "19:15", 
        "19:30", "19:45", "20:00", "20:15", 
        "20:30", "20:45", "21:00", "21:15", 
        "21:30", "21:45"
    ];
    
    // Global variable to keep track of the next ID
    let nextId = 1;
    
    // Fetch JSON data from GitHub
    async function fetchJsonFile() {
        const url = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${filePath}`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            console.log('Fetched data:', data); // Debug log
            // Determine the next ID from existing data
            const allIds = data.map(slot => slot.id);
            nextId = allIds.length > 0 ? Math.max(...allIds) + 1 : 1;
            return data;
        } catch (error) {
            console.error('Failed to fetch JSON file:', error);
        }
    }
    
    // Update JSON file on GitHub
    async function updateJsonFile(updatedData) {
        const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
        try {
            // Get the current file content and SHA
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            if (!response.ok) throw new Error('Network response was not ok');
            const { content, sha } = await response.json();
            const currentData = JSON.parse(atob(content));
    
            // Update or add new time slots
            updatedData.forEach(slot => {
                const index = currentData.findIndex(existingSlot => existingSlot.id === slot.id && existingSlot.date === slot.date);
                if (index !== -1) {
                    currentData[index] = slot; // Update existing slot
                } else {
                    currentData.push(slot); // Add new slot
                }
            });
    
            // Prepare updated content
            const updatedContent = btoa(JSON.stringify(currentData, null, 2));
    
            // Update file on GitHub
            await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Update blocked time slots',
                    content: updatedContent,
                    sha: sha
                })
            });
    
            // Show confirmation message
            showConfirmationMessage('Update successful!');
        } catch (error) {
            console.error('Failed to update JSON file:', error);
        }
    }
    
    // Show confirmation message
    function showConfirmationMessage(message) {
        const confirmationDiv = document.getElementById('confirmationMessage');
        confirmationDiv.textContent = message;
        confirmationDiv.style.display = 'block';
        setTimeout(() => confirmationDiv.style.display = 'none', 5000); // Hide after 5 seconds
    }
    
    // Generate time slots for a given date
    function generateTimeSlots(newDate) {
        const timeSlots = [newDate];
    
        morningSlots.forEach(time => {
            timeSlots.push({ id: nextId++,  time, booked: false });
        });
    
        eveningSlots.forEach(time => {
            timeSlots.push({ id: nextId++,  time, booked: false });
        });
    
        return timeSlots;
    }
    
    // Populate time options based on the selected date
    async function populateTimeOptions() {
        try {
            const selectedDate = document.getElementById('blockDate').value || document.getElementById('unblockDate').value;
            if (!selectedDate) return;
    
            const data = await fetchJsonFile();
            if (!data) return;
    
            const blockSelect = document.getElementById('blockTime');
            const unblockSelect = document.getElementById('unblockTime');
    
            // Clear existing options
            blockSelect.innerHTML = '<option value="">Select a time</option>';
            unblockSelect.innerHTML = '<option value="">Select a time</option>';
    
            // Populate block options
            data.forEach(slot => {
                if (slot.date === selectedDate && !slot.booked) {
                    const option = document.createElement('option');
                    option.value = slot.id;
                    option.textContent = `Time: ${slot.time}`;
                    blockSelect.appendChild(option);
                }
            });
    
            if (blockSelect.options.length === 1) {
                const option = document.createElement('option');
                option.textContent = 'No available slots for this date';
                blockSelect.appendChild(option);
            }
    
            // Populate unblock options
            data.forEach(slot => {
                if (slot.date === selectedDate && slot.booked) {
                    const option = document.createElement('option');
                    option.value = slot.id;
                    option.textContent = `Time: ${slot.time}`;
                    unblockSelect.appendChild(option);
                }
            });
    
            if (unblockSelect.options.length === 1) {
                const option = document.createElement('option');
                option.textContent = 'No blocked slots for this date';
                unblockSelect.appendChild(option);
            }
        } catch (error) {
            console.error('Error populating time options:', error);
        }
    }
    
    // Handle form submission for blocking time slots
    document.getElementById('blockForm').addEventListener('submit', async function(event) {
        event.preventDefault();
    
        const selectedDate = document.getElementById('blockDate').value;
        const selectedTimeId = document.getElementById('blockTime').value;
        if (selectedDate && selectedTimeId) {
            try {
                const data = await fetchJsonFile();
                if (!data) return;
    
                // Find the time slot to block
                const timeSlot = data.find(slot => slot.id == selectedTimeId && slot.date === selectedDate);
                if (timeSlot) {
                    timeSlot.booked = true; // Block the slot
    
                    await updateJsonFile([timeSlot]);
    
                    // Display the updated item on the page
                    const listItem = document.createElement('li');
                    listItem.textContent = `Date: ${timeSlot.date}, Time: ${timeSlot.time}, Booked: ${timeSlot.booked ? 'Yes' : 'No'}`;
                    document.getElementById('blockedItems').appendChild(listItem);
    
                    // Update the select options
                    populateTimeOptions();
                } else {
                    console.log('Time slot not found for the selected date.');
                }
            } catch (error) {
                console.error('Error blocking time slot:', error);
            }
        } else {
            console.log('Please select both date and time.');
        }
    });
    
    // Handle form submission for unblocking time slots
    document.getElementById('unblockForm').addEventListener('submit', async function(event) {
        event.preventDefault();
    
        const selectedDate = document.getElementById('unblockDate').value;
        const selectedTimeId = document.getElementById('unblockTime').value;
        if (selectedDate && selectedTimeId) {
            try {
                const data = await fetchJsonFile();
                if (!data) return;
    
                // Find the time slot to unblock
                const timeSlot = data.find(slot => slot.id == selectedTimeId && slot.date === selectedDate);
                if (timeSlot) {
                    timeSlot.booked = false; // Unblock the slot
    
                    await updateJsonFile([timeSlot]);
    
                    // Display the updated item on the page
                    const listItem = document.createElement('li');
                    listItem.textContent = `Date: ${timeSlot.date}, Time: ${timeSlot.time}, Booked: ${timeSlot.booked ? 'Yes' : 'No'}`;
                    document.getElementById('blockedItems').appendChild(listItem);
    
                    // Update the select options
                    populateTimeOptions();
                } else {
                    console.log('Time slot not found for the selected date.');
                }
            } catch (error) {
                console.error('Error unblocking time slot:', error);
            }
        } else {
            console.log('Please select both date and time.');
        }
    });
    
    // Handle form submission for adding new time slots
    document.getElementById('addForm').addEventListener('submit', async function(event) {
        event.preventDefault();
    
        const newDate = document.getElementById('newDate').value;
        if (newDate) {
            try {
                const timeSlots = generateTimeSlots(newDate);
                const data = await fetchJsonFile();
                if (!data) return;
    
                const existingSlots = data.filter(slot => slot.date === newDate);
                const newSlots = timeSlots.filter(slot => !existingSlots.find(existingSlot => existingSlot.time === slot.time));
    
                if (newSlots.length > 0) {
                    data.push(...newSlots);
    
                    await updateJsonFile(data);
    
                    showConfirmationMessage('New time slots added successfully');
                    populateTimeOptions();
                } else {
                    console.log('Time slots already exist for this date.');
                }
            } catch (error) {
                console.error('Error adding new time slots:', error);
            }
        } else {
            console.log('Please provide a date.');
        }
    });
    
    // Initialize time slots and update options on page load and date change
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('blockDate').addEventListener('change', populateTimeOptions);
        document.getElementById('unblockDate').addEventListener('change', populateTimeOptions);
        populateTimeOptions(); // Load time options on page load
    });
        </script>
    </body>
</html>
