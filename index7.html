<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Time Slots</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
        }
        input, select {
            padding: 8px;
            width: 200px;
            margin-right: 10px;
        }
        button {
            padding: 10px 20px;
        }
        #confirmationMessage {
            display: none;
            padding: 10px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin-top: 20px;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <h1>Manage Time Slots</h1>

    <!-- Form for Blocking Time Slots -->
    <h2>Block Time Slot</h2>
    <form id="blockForm">
        <label for="blockDate">Select Date:</label>
        <input type="date" id="blockDate" name="blockDate" required>
        
        <label for="blockTime">Select Time:</label>
        <select id="blockTime" name="blockTime" required>
            <option value="">Select a time</option>
        </select>

        <button type="submit">Block Time Slot</button>
    </form>

    <!-- Form for Unblocking Time Slots -->
    <h2>Unblock Time Slot</h2>
    <form id="unblockForm">
        <label for="unblockDate">Select Date:</label>
        <input type="date" id="unblockDate" name="unblockDate" required>
        
        <label for="unblockTime">Select Time:</label>
        <select id="unblockTime" name="unblockTime" required>
            <option value="">Select a time</option>
        </select>

        <button type="submit">Unblock Time Slot</button>
    </form>

    <!-- Form for Adding New Time Slots -->
    <h2>Add New Time Slots</h2>
    <form id="addForm">
        <label for="newDate">Select Date:</label>
        <input type="date" id="newDate" name="newDate" required>

        <button type="submit">Add Time Slots</button>
    </form>

    <!-- Display confirmation message -->
    <div id="confirmationMessage"></div>

    <!-- Display blocked time slots -->
    <h2>Blocked Time Slots</h2>
    <ul id="blockedItems"></ul>

    <script>
        // GitHub configuration
        const token = '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'; // Replace with your GitHub PAT
        const repoOwner = 'Varmaclinic'; // Replace with your GitHub username
        const repoName = 'blocked-dates'; // Replace with your repository name
        const filePath = 'blocked-dates.json'; // Correct file path

        const jsonUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${filePath}`;

        // Time slot intervals
        const morningSlots = [
            "09:00", "09:15", "09:30", "09:45", 
            "10:00", "10:15", "10:30", "10:45", 
            "11:00", "11:15", "11:30", "11:45"
        ];
        const eveningSlots = [
            "18:30", "18:45", "19:00", "19:15", 
            "19:30", "19:45", "20:00", "20:15", 
            "20:30", "20:45", "21:00", "21:15", 
            "21:30", "21:45"
        ];

        // Global variable to keep track of the next ID
        let nextId = 1;

        async function fetchJsonData() {
            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error('Error fetching JSON data:', error);
                return [];
            }
        }

        async function updateJsonData(newData) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!response.ok) throw new Error('Network response was not ok');
                const { content, sha } = await response.json();
                const currentData = JSON.parse(atob(content));

                // Update or add new data
                newData.forEach(item => {
                    const index = currentData.findIndex(existingItem => existingItem.id === item.id && existingItem.date === item.date);
                    if (index !== -1) {
                        currentData[index] = item; // Update existing item
                    } else {
                        currentData.push(item); // Add new item
                    }
                });

                const updatedContent = btoa(JSON.stringify(currentData, null, 2));
                await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Update blocked time slots',
                        content: updatedContent,
                        sha: sha
                    })
                });
                showConfirmationMessage('Update successful!');
            } catch (error) {
                console.error('Error updating JSON data:', error);
            }
        }

        function showConfirmationMessage(message) {
            const confirmationDiv = document.getElementById('confirmationMessage');
            confirmationDiv.textContent = message;
            confirmationDiv.style.display = 'block';
            setTimeout(() => confirmationDiv.style.display = 'none', 5000); // Hide after 5 seconds
        }

        function generateTimeSlots(newDate) {
            const timeSlots = [];
            morningSlots.forEach(time => {
                timeSlots.push({ id: nextId++, date: newDate, time, booked: false });
            });
            eveningSlots.forEach(time => {
                timeSlots.push({ id: nextId++, date: newDate, time, booked: false });
            });
            return timeSlots;
        }

        async function populateTimeOptions() {
            try {
                const selectedDate = document.getElementById('blockDate').value || document.getElementById('unblockDate').value;
                if (!selectedDate) return;

                const data = await fetchJsonData();
                if (!data) return;

                const blockSelect = document.getElementById('blockTime');
                const unblockSelect = document.getElementById('unblockTime');

                blockSelect.innerHTML = '<option value="">Select a time</option>';
                unblockSelect.innerHTML = '<option value="">Select a time</option>';

                data.forEach(slot => {
                    if (slot.date === selectedDate) {
                        const option = document.createElement('option');
                        option.value = slot.id;
                        option.textContent = `Time: ${slot.time}`;
                        if (!slot.booked) {
                            blockSelect.appendChild(option);
                        } else {
                            unblockSelect.appendChild(option);
                        }
                    }
                });

                if (blockSelect.options.length === 1) {
                    const option = document.createElement('option');
                    option.textContent = 'No available slots for this date';
                    blockSelect.appendChild(option);
                }

                if (unblockSelect.options.length === 1) {
                    const option = document.createElement('option');
                    option.textContent = 'No blocked slots for this date';
                    unblockSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error populating time options:', error);
            }
        }

        document.getElementById('blockForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const selectedDate = document.getElementById('blockDate').value;
            const selectedTimeId = document.getElementById('blockTime').value;
            if (selectedDate && selectedTimeId) {
                try {
                    const data = await fetchJsonData();
                    if (!data) return;

                    const timeSlot = data.find(slot => slot.id == selectedTimeId && slot.date === selectedDate);
                    if (timeSlot) {
                        timeSlot.booked = true;

                        await updateJsonData([timeSlot]);

                        const listItem = document.createElement('li');
                        listItem.textContent = `Date: ${timeSlot.date}, Time: ${timeSlot.time}, Booked: ${timeSlot.booked ? 'Yes' : 'No'}`;
                        document.getElementById('blockedItems').appendChild(listItem);

                        showConfirmationMessage('Time slot blocked successfully');
                        populateTimeOptions();
                    } else {
                        console.log('Selected time slot not found.');
                    }
                } catch (error) {
                    console.error('Error blocking time slot:', error);
                }
            } else {
                console.log('Please select a date and time.');
            }
        });

        document.getElementById('unblockForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const selectedDate = document.getElementById('unblockDate').value;
            const selectedTimeId = document.getElementById('unblockTime').value;
            if (selectedDate && selectedTimeId) {
                try {
                    const data = await fetchJsonData();
                    if (!data) return;

                    const timeSlot = data.find(slot => slot.id == selectedTimeId && slot.date === selectedDate);
                    if (timeSlot) {
                        timeSlot.booked = false;

                        await updateJsonData([timeSlot]);

                        showConfirmationMessage('Time slot unblocked successfully');
                        populateTimeOptions();
                    } else {
                        console.log('Selected time slot not found.');
                    }
                } catch (error) {
                    console.error('Error unblocking time slot:', error);
                }
            } else {
                console.log('Please select a date and time.');
            }
        });

        document.getElementById('addForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const newDate = document.getElementById('newDate').value;
            if (newDate) {
                try {
                    const data = await fetchJsonData();
                    if (!data) return;

                    const existingDate = data.find(entry => entry.date === newDate);
                    if (!existingDate) {
                        const newSlots = generateTimeSlots(newDate);
                        await updateJsonData(newSlots);
                        showConfirmationMessage('New time slots added successfully');
                    } else {
                        console.log('Date already exists.');
                    }
                } catch (error) {
                    console.error('Error adding new time slots:', error);
                }
            } else {
                console.log('Please provide a date.');
            }
        });

        // Initial fetch to populate the list of blocked items and time options
        (async () => {
            try {
                const data = await fetchJsonData();
                if (data) {
                    data.forEach(slot => {
                        if (slot.booked) {
                            const listItem = document.createElement('li');
                            listItem.textContent = `Date: ${slot.date}, Time: ${slot.time}, Booked: ${slot.booked ? 'Yes' : 'No'}`;
                            document.getElementById('blockedItems').appendChild(listItem);
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing blocked items:', error);
            }

            // Populate time options initially
            populateTimeOptions();
        })();
    </script>
</body>
</html>
